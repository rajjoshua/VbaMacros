Function ExtractName(s As String) As String
    Dim regEx As New RegExp
    With regEx
        .Global = False
        .Pattern = "^[A-Za-z, ]+"
        .IgnoreCase = True
    End With
    
    Dim matches As MatchCollection
    Set matches = regEx.Execute(s)
    
    If matches.Count > 0 Then
        ExtractName = Trim(matches(0).Value)
    Else
        ExtractName = s
    End If
End Function

Sub ExtractDetailsFromEmailAndDocument()

    Dim OlMail As Outlook.MailItem
    Dim objAttachment As Outlook.Attachment
    Dim WordDoc As Object
    Dim WordApp As Object
    Dim tbl As Object, row As Object
    Dim ApproversInWord As String, SenderName As String, SendersInMails As String
    Dim EmbeddedMail As Outlook.MailItem
    Dim FirstLines As String
    Dim LineArray() As String

    ' Get the selected mail
    On Error Resume Next
    Set OlMail = Application.ActiveExplorer.Selection.Item(1)

    ' Extract Approvers from Word Attachment
    If Not OlMail Is Nothing Then
        For Each objAttachment In OlMail.Attachments
            If InStr(objAttachment.FileName, ".doc") > 0 Then
                ' Temporarily save the attachment
                objAttachment.SaveAsFile Environ("Temp") & "\" & objAttachment.FileName

                ' Open the Word document
                Set WordApp = GetObject(, "Word.Application")
                If WordApp Is Nothing Then Set WordApp = CreateObject("Word.Application")

                Set WordDoc = WordApp.Documents.Open(Environ("Temp") & "\" & objAttachment.FileName)
                WordApp.Visible = False

                If WordDoc.Tables.Count >= 3 Then
                    Set tbl = WordDoc.Tables(3)
                    For Each row In tbl.Rows
                        If InStr(row.Cells(5).Range.Text, "X") > 0 Then
                            ApproversInWord = ApproversInWord & ExtractName(Trim(row.Cells(1).Range.Text)) & vbNewLine
                        End If
                    Next row
                End If

                ' Close without saving
                WordDoc.Close wdDoNotSaveChanges
                ' Delete the temp file
                Kill Environ("Temp") & "\" & objAttachment.FileName
            End If
        Next objAttachment
    End If

    ' Show approver names from the Word document
    If ApproversInWord <> "" Then
        MsgBox "Approvers from Word Document:" & vbNewLine & ApproversInWord
    End If

    ' Loop through embedded email attachments, check if "approved" is in the top response and display sender names
    For Each objAttachment In OlMail.Attachments
        If objAttachment.Type = olEmbeddeditem Then
            ' Save and Open the embedded email
            objAttachment.SaveAsFile Environ("Temp") & "\embeddedMail.msg"
            Set EmbeddedMail = Application.CreateItemFromTemplate(Environ("Temp") & "\embeddedMail.msg")
            
            ' Extract the first few lines of the email
            LineArray = Split(EmbeddedMail.Body, vbNewLine)
            FirstLines = Join(Array(LineArray(0), LineArray(1), LineArray(2)), " ") ' Assuming the response is within the first three lines

            ' Check if the word "approved" is in the top response
            If InStr(1, FirstLines, "approved", vbTextCompare) > 0 Then
                SendersInMails = SendersInMails & ExtractName(EmbeddedMail.SenderName) & vbNewLine
            End If
        End If
    Next objAttachment

    ' Show sender names from the emails
    If SendersInMails <> "" Then
        MsgBox "Senders from Mails:" & vbNewLine & SendersInMails
    End If

    ' Validation
    Dim arrApproversInWord() As String
    Dim arrSendersInMails() As String
    Dim matchingNames As String, mismatchedNames As String

    arrApproversInWord = Split(ApproversInWord, vbNewLine)
    arrSendersInMails = Split(SendersInMails, vbNewLine)

    For i = LBound(arrApproversInWord) To UBound(arrApproversInWord)
        If arrApproversInWord(i) <> "" Then
            If InStr(1, SendersInMails, arrApproversInWord(i), vbTextCompare) > 0 Then
                matchingNames = matchingNames & arrApproversInWord(i) & vbNewLine
            Else
                mismatchedNames = mismatchedNames & arrApproversInWord(i) & vbNewLine
            End If
        End If
    Next i

    ' Display results
    If matchingNames <> "" Then
        MsgBox "Matching Names:" & vbNewLine & matchingNames
    End If
    If mismatchedNames <> "" Then
        MsgBox "Mismatched Names:" & vbNewLine & mismatchedNames
    End If

    Set OlMail = Nothing
    Set objAttachment = Nothing
    Set EmbeddedMail = Nothing
    Set WordDoc = Nothing
    Set WordApp = Nothing

End Sub
