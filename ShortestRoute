import openpyxl

# Load the input workbook
input_wb = openpyxl.load_workbook("input.xlsx")

# Get the active worksheet
input_ws = input_wb.active

# Create a new workbook for the output
output_wb = openpyxl.Workbook()

# Get the active worksheet in the output workbook
output_ws = output_wb.active

# Write the headers for the output table
output_ws["A1"] = "Step"
output_ws["B1"] = "Roles"

# Get the maximum row and column count
max_row = input_ws.max_row
max_col = input_ws.max_column

# Create a dictionary to store the role columns
roles = {}

# Loop through each row of the input worksheet
for row in range(2, max_row+1):
    # Get the source step from column A
    source_step = input_ws.cell(row=row, column=1).value
    
    # Get the target steps from column B
    target_steps = input_ws.cell(row=row, column=2).value.split(",")
    
    # Loop through each target step
    for target_step in target_steps:
        # Get the roles that can perform the step change from the respective column
        for col in range(3, max_col+1):
            role_name = input_ws.cell(row=1, column=col).value
            if role_name not in roles:
                roles[role_name] = []
            role_value = input_ws.cell(row=row, column=col).value
            if role_value == "Yes":
                roles[role_name].append(target_step)
        
        # Write the source step and target step to the output worksheet
        output_ws.append([source_step, target_step])
        
        # Write the roles that can perform the step change to the output worksheet
        role_list = []
        for role_name, allowed_steps in roles.items():
            if target_step in allowed_steps:
                role_list.append(role_name)
        output_ws.cell(row=output_ws.max_row, column=2, value=", ".join(role_list))

        # Clear the roles dictionary for the next target step
        roles.clear()

# Save the output workbook
output_wb.save("output.xlsx")
